<HTML>
<CENTER><A HREF = "Minnows.html">Previous Section</A> - <A HREF = "http://www.sandia.gov/~sjplimp/phish.html">PHISH WWW Site</A> -
<A HREF = "Manual.html">PHISH, Documentation</A> - <A HREF = "Examples.html">Next Section</A> 
</CENTER>




<HR>

<H3>4. PHISH Library 
</H3>
<P>This is the API to the PHISH library that PHISH minnows call.  In
PHISH lingo, a "minnow" is a stand-alone application which makes calls
to the <A HREF = "Library.html">PHISH library</A>.
</P>
<P>The API for the MPI and socket versions of the PHISH library are
identical.
</P>
<P>A general discussion of how and when minnows call PHISH library
functions is given in the <A HREF = "Minnows.html">Minnows</A> section of the
manual.
</P>
<P>The PHISH library has a C-style API, so it is easy to write minnows in
any language, e.g. C, C++, Fortran, Python.  A C++-style API is also
provided, which means a C++ program can use either the C or C++ API.
A Python wrapper on the C-style API.  The doc pages for individual
library functions document all 3 APIs; they are very similar.  See the
section below entitled <A HREF = "#library_2">C vs C++ vs Python interface</A> for a
quick overview.
</P>
<P>PHISH minnows communicate with other minnows by sending and receiving
datums.  Before looking at individual library calls, it may be helpful
to understand how data is stored internally in a datum by the PHISH
library.  This topic is discussed below, in the section entitled
<A HREF = "#library_3">Format of a datum</A>.
</P>
<UL><LI>4.1 <A HREF = "#library_1">List of library functions</A>
<LI>4.2 <A HREF = "#library_2">Building the PHISH library</A>
<LI>4.3 <A HREF = "#library_3">C vs C++ vs Python interface</A>
<LI>4.4 <A HREF = "#library_4">Format of a datum</A> 
</UL>
<HR>

<HR>

<A NAME = "library_1"></A><H4>4.1 List of library functions 
</H4>
<P>The PHISH library is not large; there are only a handful of calls.
They can be grouped into the following categories.  Follow the links
to see a doc page for each library call.  
</P>
<OL><LI>Library calls for initialization 

<UL>  <A HREF = "phish_init.html">phish_init()</A> 
<BR>
  <A HREF = "phish_port.html">phish_input()</A> 
<BR>
  <A HREF = "phish_port.html">phish_output()</A> 
<BR>
  <A HREF = "phish_callback.html">phish_callback()</A> 
<BR>
  <A HREF = "phish_check.html">phish_check()</A> 
<BR></UL>
<LI>Library calls for shutdown 

<UL>  <A HREF = "phish_shutdown.html">phish_exit()</A> 
<BR>
  <A HREF = "phish_shutdown.html">phish_close()</A> 
<BR></UL>
<LI>Library calls for receiving datums 

<UL>  <A HREF = "phish_loop.html">phish_loop()</A> 
<BR>
  <A HREF = "phish_probe.html">phish_probe()</A> 
<BR>
  <A HREF = "phish_recv.html">phish_recv()</A> 
<BR>
  <A HREF = "phish_unpack.html">phish_unpack()</A> 
<BR>
  <A HREF = "phish_unpack.html">phish_datum()</A> 
<BR></UL>
<LI>Library calls for sending datums 

<UL>  <A HREF = "phish_send.html">phish_send()</A> 
<BR>
  <A HREF = "phish_send.html">phish_send_key()</A> 
<BR>
  <A HREF = "phish_send.html">phish_send_direct()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_repack()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_raw()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_char()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int8()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int16()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int32()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int64()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint8()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint16()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint32()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint64()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_float()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_double()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_string()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int8_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int16_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int32_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_int64_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint8_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint16_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint32_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_uint64_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_float_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_double_array()</A> 
<BR>
  <A HREF = "phish_pack.html">phish_pack_pickle()</A> 
<BR></UL>
<LI>Library calls for queueing datums 

<UL>  <A HREF = "phish_queue.html">phish_queue()</A> 
<BR>
  <A HREF = "phish_queue.html">phish_dequeue()</A> 
<BR>
  <A HREF = "phish_queue.html">phish_nqueue()</A> 
<BR></UL>
<LI>Miscellaneous library calls 

<UL>  <A HREF = "phish_info.html">phish_query()</A> 
<BR>
  <A HREF = "phish_info.html">phish_set()</A> 
<BR>
  <A HREF = "phish_error.html">phish_error()</A> 
<BR>
  <A HREF = "phish_error.html">phish_warn()</A> 
<BR>
  <A HREF = "phish_error.html">phish_abort()</A> 
<BR>
  <A HREF = "phish_timer.html">phish_timer()</A> 
<BR></UL>

</OL>
<HR>

<A NAME = "library_2"></A><H4>4.2 Building the PHISH library 
</H4>
<P>There are two different versions of the PHISH library that can be
built.  One that calls message-passing functions from the MPI library,
and one that calls socket functions from the ZMQ library.
</P>
<P>You can build either version from the src directory
of the distribution by typing one of these lines:
</P>
<PRE>make -f Makefile.machine mpi
make -f Makefile.machine zmq 
</PRE>
<P>where "machine" is the name of one of the Makefiles
in the directory. 
</P>
<P>If none of the provided files work for your machine, then you can use
of them as a template for creating your own, e.g. Makefile.foo.  Note
that only the top section for compiler/linker settings need be edited.
</P>
<P>This is where you should specify your compiler and any switches it
uses.  The MPI_INC setting is only needed if you are building the MPI
version of the library, and the compiler needs to know where to find
the mpi.h file.  Likewise the ZMQ_INC setting is only needed if you
are building the ZMQ version of the library, and the compiler needs to
know where to find the zmq.h file.
</P>
<P>If the build is successful, a libphish-mpi.a or libphish-zmq.a file is
produced.
</P>
<P>You can also type 
</P>
<PRE>make -f Makefile.machine clean 
</PRE>
<P>to remove *.o and lib*.a files from the directory.
</P>
<HR>

<A NAME = "library_3"></A><H4>4.3 C vs C++ vs Python interface 
</H4>
<P>As noted above, the APIs to the PHISH library for
C versus C++ versus Python are very simliar.  A C++ program
can use either the C or C++ API.
</P>
<P>To use the C interface, a C or C++ program includes the file
src/phish.h and makes calls to functions as follows:
</P>
<PRE>#include "phish.h"
phish_error("My error"); 
</PRE>
<P>NOTE: should namespace be PHISH or phish or Phish?
      change in phish.hpp accordingly
</P>
<P>The C++ interface in src/phish.hpp encloses the PHISH API in the
namespace "PHISH", so functions can be invoked as
</P>
<PRE>#include "phish.hpp"
PHISH::error("My error"); 
</PRE>
<P>or as
</P>
<PRE>#include "phish.hpp"
using namespace PHISH
error("My error"); 
</PRE>
<P>To use the Python interface, the Python PHISH wrapper needs to be
installed in your machine's Python.  See <A HREF = "Section_python.html">this
section</A> of the manual for details.
A Python program can then invoke a library function as
</P>
<PRE>import phish
phish.error("My error") 
</PRE>
<P>or 
</P>
<PRE>from import phish *
error("My error") 
</PRE>
<HR>

<A NAME = "library_4"></A><H4>4.4 Format of a datum 
</H4>
<P>The chief function of the PHISH library is to facilitate the exchange
of data between minnows.  This is done through datums, which contain
one or more fields of data.  Each field is a fundamental data type
such as a "32-bit integer" or a "vector of doubles" or a
NULL-terminated character string.
</P>
<P>The PHISH library defines a specific explicit type for each
fundamental data type it recognizes, such as "int32" for 32-bit signed
integers or "uint64" for 64-bit unsigned integers, or "double" for a
double-precision value.  This is so that the format of the datum, at
the byte level, is identical on different machines, and datums can
thus be exchanged between minnows running on machines with different
word lengths or between minnows written in different languages (e.g. C
vs Fortran vs Python).
</P>
<P>IMPORTANT NOTE: Different endian ordering of fundamental numeric data
types on different machines breaks this model.  We may address this at
some future time within the PHISH library.
</P>
<P>This is the byte-level format of datums that are sent and received by
minnows:
</P>
<UL><LI># of fields in datum (int32_t)
<LI>type of 1st field (int32_t)
<LI>size of 1st field (optional int32_t)
<LI>data for 1st field (bytes)
<LI>type of 2nd field (int32_t)
<LI>size of 2nd field (optional int32_t)
<LI>data for 2nd field (bytes)
<LI>...
<LI>type of Nth field (int32_t)
<LI>size of Nth field (optional int32_t)
<LI>data for Nth field (bytes) 
</UL>
<P>Integer flags are interleaved with the fundamental data types and the
flags are all 32-bit signed integers.  This allows minnows that call
the <A HREF = "phish_pack.html">phish_pack</A> and <A HREF = "phish_unpack.html">phish_unpack</A>
functions to use the usual C "int" data type as function arguments,
instead of the int32_t types defined in the function prototypes.  The
compiler will only give an error if the native "int" on a machine is
not a 32-bit integer.  See the doc pages for
<A HREF = "phish_pack.html">phish_pack</A> and <A HREF = "phish_unpack.html">phish_unpack</A> for
details.
</P>
<P>The "type" values are one of these settings, as defined in
src/phish.h:
</P>
<UL><LI>PHISH_RAW = 0
<LI>PHISH_CHAR = 1
<LI>PHISH_INT8 = 2
<LI>PHISH_INT16 = 3
<LI>PHISH_INT32 = 4
<LI>PHISH_INT64 = 5
<LI>PHISH_UINT8 = 6
<LI>PHISH_UINT16 = 7
<LI>PHISH_UINT32 = 8
<LI>PHISH_UINT64 = 9
<LI>PHISH_FLOAT = 10
<LI>PHISH_DOUBLE = 11
<LI>PHISH_STRING = 12
<LI>PHISH_INT8_ARRAY = 13
<LI>PHISH_INT16_ARRAY = 14
<LI>PHISH_INT32_ARRAY = 15
<LI>PHISH_INT64_ARRAY = 16
<LI>PHISH_UINT8_ARRAY = 17
<LI>PHISH_UINT16_ARRAY = 18
<LI>PHISH_UINT32_ARRAY = 19
<LI>PHISH_UINT64_ARRAY = 20
<LI>PHISH_FLOAT_ARRAY = 21
<LI>PHISH_DOUBLE_ARRAY = 22
<LI>PHISH_PICKLE = 23 
</UL>
<P>PHISH_RAW is a string of raw bytes, which can be of any length, and
which the minnow can format in any manner.  PHISH_CHAR, PHISH_INT*,
PHISH_UINT*, PHISH_FLOAT, and PHISH_DOUBLE are a single character,
signed integer (of length 8,16,32,64 bits), unsigned integer (of
length 8,16,32,64 bits), a float (typically 4 bytes), and double
(typically 8 bytes).  PHISH_STRING is a standard C-style
NULL-terminated C-string.  The NULL is included in the field.  The
ARRAYS are contiguous sequences of int*, uint*, float, or double
values.  PHISH_PICKLE is used by the Python wrapper on the PHISH
library to encode arbitrary Python objects in pickled form as a string
of bytes.
</P>
<P>The "size" values are only included for PHISH_RAW (# of bytes),
PHISH_STRING (# of bytes including NULL), the ARRAY types (# of
values), and PHISH_PICKLE (# of bytes).
</P>
<P>The field data is packed into the datum in a contiguous manner.
This means that no attention is paid to alignment of integer
or floating point values.
</P>
<P>The maximum allowed size of an entire datum (in bytes) is set to a
default value of 1024 bytes or 1 Kbyte.  This can be overridden via
the <A HREF = "bait_set.html">set memory</A> command in a PHISH input script.
</P>
<P>When a datum is sent to another minnow via the MPI version of the
PHISH library, MPI flags the message with an MPI "tag".  This tag
encodes the receiving minnow's input port and also a "done" flag.
Specifically, if the datum is not a done message, the tag is the
receiver's input port (0 to Nport-1).  For a done message a value of
MAXPORT (defined at the top of src/phish.cpp) is added to the tag.
</P>
<P>NOTE: MAXPORT is hardwired, could re-compile - this is
so all minnows use same setting.
</P>
<P>See the <A HREF = "phish_port.html">phish_input</A> doc page for a discussion of
ports.  See the <A HREF = "Minnows.html#shutdown">shutdown section</A> of the
<A HREF = "Minnows.html">Minnows</A> doc page for a discussion of "done" messages.
</P>
<P>TIM: How is this encoding of port and done implemented for sockets?
</P>
</HTML>
