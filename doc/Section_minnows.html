<HTML>
<CENTER><A HREF = "Bait.html">Previous Section</A> - <A HREF = "http://phish.sandia.gov">PHISH WWW Site</A> -
<A HREF = "Manual.html">PHISH Documentation</A> - <A HREF = "Library.html">Next Section</A> 
</CENTER>




<HR>

<H3>3. PHISH Minnows 
</H3>
<P>In PHISH lingo, a "minnow" is a stand-alone program which makes calls
to the <A HREF = "Library.html">PHISH library</A>.  Often they are small programs
which perform a single task, e.g. they parse a string into keywords
and store statistics on those keywords.  But they can also be large
programs which perform sophisticated computations and make only a few
calls to the PHISH library.  In which case they should probably be
called sharks or whales ...
</P>
<P>An individual minnow is part of a school of one or more duplicate
minnows.  One or more schools make a PHISH net(work) which works
together to perform a calculation.  Minnows communicate with each
other to exchange data via calls to the PHISH library.
</P>
<P>This doc page covers these topics:
</P>
<UL><LI>3.1 <A HREF = "#minnow_1">List of minnows</A>
<LI>3.2 <A HREF = "#minnow_2">Code structure of a minnow</A>
<LI>3.3 <A HREF = "#minnow_3">Communication via ports</A>
<LI>3.4 <A HREF = "#minnow_4">Shutting down a minnow</A>
<LI>3.5 <A HREF = "#minnow_5">Building a minnow</A> 
</UL>
<HR>

<HR>

<A NAME = "minnow_1"></A><H4>3.1 List of minnows 
</H4>
<P>This is a list of minnows in the minnow directory of the PHISH
distribution.  Each has its own doc page.  Some are written in C++,
some in Python, some in both:
</P>
<UL><LI><A HREF = "count.html">count</A>
<LI><A HREF = "file2fields.html">file2fields</A>
<LI><A HREF = "file2words.html">file2words</A>
<LI><A HREF = "filegen.html">filegen</A>
<LI><A HREF = "ping.html">ping</A>
<LI><A HREF = "pong.html">pong</A>
<LI><A HREF = "print.html">print</A>
<LI><A HREF = "readgraph.html">readgraph</A>
<LI><A HREF = "rmat.html">rmat</A>
<LI><A HREF = "slowdown.html">slowdown</A>
<LI><A HREF = "sort.html">sort</A> 
</UL>
<P>These are special minnows which can wrap stand-alone non-PHISH
executables which read from stdin and write to stdout, so that they
can be used as minnows in a PHISH net and communicate with other
minnows:
</P>
<UL><LI><A HREF = "wrapsink.html">wrapsink</A>
<LI><A HREF = "wrapsource.html">wrapsource</A>
<LI><A HREF = "wrapss.html">wrapss</A> 
</UL>
<P>These are simple codes which can be compiled into stand-alone
non-PHISH executables.  They are examples of code that can be wrapped
by the "wrap" minnows:
</P>
<UL><LI><A HREF = "echo.html">echo</A>
<LI><A HREF = "reverse.html">reverse</A> 
</UL>
<HR>

<A NAME = "minnow_2"></A><H4>3.2 Code structure of a minnow 
</H4>
<P>The best way to make sense of how a minnow makes calls to the PHISH
library, is to examine a few simple ones from the minnow directory.
Here we list the count.py minnow which is written in Python.  There is
a also a count.cpp minnow, written in C++, which does the same thing.
The purpose of this minnow is to ...
</P>
<PRE>1   #!/usr/local/bin/python
2
3   import sys,os,glob,copy
4   import phish
5
6   def count(nvalues):
7     if nvalues != 1: phish.error("Count processes one-value datums")
8     type,str,tmp = phish.unpack()
9     if type != phish.STRING:
10      phish.error("File2words processes string values")
11    if hash.has_key(str): hash<B>str</B> = hash<B>str</B> + 1
12    else: hash<B>str</B> = 1
13
14  def sort():
15    pairs = hash.items()
16    for key,value in pairs:
17      phish.pack_int(value)
18      phish.pack_string(key)
19      phish.send(0)
20
21  args = phish.init(sys.argv)
22  phish.input(0,count,sort,1)
23  phish.output(0)
24  phish.check()
25
26  if len(args) != 0: phish.error("Count syntax: count")
27
28  hash = <I></I>
29  
30  phish.loop()
31  phish.exit() 
</PRE>
<P>Note that on line 4, the Python minnow imports the phish module, which
is provided with the PHISH distribution.  Instructions on how to
build this module, which wraps the PHISH library, and add it to your
Python are given in "this section" of the documentation.
</P>
<P>The main program begins on line 21.  The call to phish.init() is
typically the first line of a PHISH minnow.  When the minnow is
launched, as described in "this section" extra PHISH library
command-line arguments are used to describe how the minnow will
communicate with other minnows.  These are stripped off by the
phish.init() function, and the remaining minnow-specific arguments are
returned as "args".  The phish.input() and phish.output() calls setup
the input and output ports used by the minnow.  
</P>
<P>Is this first place ports are discussed?  Or in next section?
One call for each input and each output port used by the minnow.
Callback specified for input port, which is a minnow function that
will be called when a datum is received on that input port.  Count in
this case.  A callback function to call when the input port is closed
can also be specified.  Sort in this case
</P>
<P>After errr checking, initialize hash to empty, and then call
phish.loop().  This will look for incoming datums, invoking the
callback count function when each is received.  It will not return
until all input ports are closed, which will invoke the sort function.
The minnow finally calls phish.exit() which deallocates memory
allocated by the library, and closes any output ports of the minnow,
which sends done messages to downstream minnows.
</P>
<P>Discuss count function.
</P>
<P>Discuss sort function.
</P>
<P>This structure is typical of many minnows.  A beginnning section with
calls to phish.init() and input/output ports, and phish.check().
</P>
<P>Then a call to 
loop vs probe vs recv
to receive datums.
</P>
<P>The callbacks unpack datums, process them, store state, send
messsages via phish.pack() and phish.send().
</P>
<P>After loop, etc exits, the minnow shuts down via a call to
phish.close()
or phish.exit(), since it will receive no more datums.
</P>
<HR>

<A NAME = "minnow_3"></A><H4>3.3 Communication via ports 
</H4>
<P>rules about ports
</P>
<P>Deinfe ports as in connect command
</P>
<P>many connections to one port and vice versa is
possible
</P>
<P>port is only think queryable about a message, other
than content.  Doesn't make sense to query what
connection it came on or which proc in connection.
This is b/c the input script is separate from the
minnow.  Minnow actions shouldn't depend on that
info.  If it does, then encode it in message.
</P>
<P>how general vs specific to write minnow when processing datums
  note that PHISH input script can send unexpected data to minnow
</P>
<HR>

<A NAME = "minnow_4"></A><H4>3.4 Shutting down a minnow 
</H4>
<P>regular datum vs done message
</P>
<P>For a PHISH program whose minnows operate in a pipelined
one-directional fashion (e.g. one or more minnows read input,
send datums to a 2nd set of minnows, on to a 3rd set, etc), it
is typically sufficient to trigger an orderly shutdown of
the entire program 
</P>
<P>one-way schools, triggered by head
done messages, per port level
close ports explicitly or implicitly
calls to exit, close, etc
special care for ring or chain connections
or when school has loops
Ctrl-C option
output at end
</P>
<P>shutdown in ZMQ is buggy
</P>
<HR>

<A NAME = "minnow_5"></A><H4>3.5 Building a minnow 
</H4>
<P>makefile
</P>
<P>debug a school in stages, since no connection
to an output ports is required, or could just hook output to
a print minnow
</P>
<P>use of slowdown minnow to throttle
</P>
</HTML>
